name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-south-2  # Make sure this matches your EC2 instance's region

    - name: Install AWS CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y awscli

    - name: Install Session Manager plugin
      run: |
        curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
        sudo dpkg -i session-manager-plugin.deb

    - name: Deploy to EC2
      run: |
        INSTANCE_ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=ExampleDeploymentCdkStack/DjangoScraperInstance" --query "Reservations[].Instances[].InstanceId" --output text)
        
        # Create deployment script
        cat << 'EOF' > deploy.sh
        #!/bin/bash
        set -e  # Exit immediately if a command exits with a non-zero status.

        # Ensure Python3 and pip are installed
        sudo yum update -y
        sudo yum install -y python3 python3-pip

        # Install Gunicorn
        pip3 install --user gunicorn

        # Ensure Git is configured
        git config --global user.email "deployment@example.com"
        git config --global user.name "Deployment Script"

        # Clone the repository if it doesnt exist, otherwise pull latest changes
        if [ ! -d "/home/ssm-user/django-scraper" ]; then
          git clone https://github.com/stemsrd/example-deployment.git /home/ssm-user/django-scraper
        else
          cd /home/ssm-user/django-scraper
          git pull origin main
        fi

        cd /home/ssm-user/django-scraper
        pip3 install --user -r requirements.txt
        python3 manage.py migrate
        python3 manage.py collectstatic --noinput

        # Create the systemd service file
        cat << EOT | sudo tee /etc/systemd/system/django_scraper.service > /dev/null
        [Unit]
        Description=Django Scraper Gunicorn daemon
        After=network.target

        [Service]
        User=ssm-user
        Group=ssm-user
        WorkingDirectory=/home/ssm-user/django-scraper
        ExecStart=/home/ssm-user/.local/bin/gunicorn --workers 3 --bind unix:/home/ssm-user/django-scraper/django_scraper.sock django_scraper.wsgi:application

        [Install]
        WantedBy=multi-user.target
        EOT

        sudo systemctl daemon-reload
        sudo systemctl enable django_scraper
        sudo systemctl restart django_scraper

        # Nginx configuration
        cat << EOT | sudo tee /etc/nginx/conf.d/django_scraper.conf > /dev/null
        server {
            listen 80;
            server_name _;

            location = /favicon.ico { access_log off; log_not_found off; }
            location /static/ {
                root /home/ssm-user/django-scraper;
            }

            location / {
                include proxy_params;
                proxy_pass http://unix:/home/ssm-user/django-scraper/django_scraper.sock;
            }
        }
        EOT

        sudo nginx -t && sudo systemctl restart nginx

        # Check the status of the Django service
        sudo systemctl status django_scraper
        EOF

        # Execute deployment script on the EC2 instance
        aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":["#!/bin/bash", "'"$(sed 's/"/\\"/g' deploy.sh | sed -z 's/\n/\\n/g')"'"]}' \
          --output text